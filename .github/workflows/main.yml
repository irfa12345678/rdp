name: SIMPLE-RDP
on: workflow_dispatch

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Setup RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389

    - name: Create User
      run: |
        $password = "P@ssw0rd123!"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

    - name: Get IP
      run: |
        $ip = (Invoke-WebRequest -Uri "https://api.ipify.org").Content
        echo "PUBLIC_IP=$ip" >> $env:GITHUB_ENV

    - name: Show Info
      run: |
        Write-Host "RDP Connection Info:"
        Write-Host "IP: $env:PUBLIC_IP"
        Write-Host "User: RDPUser"
        Write-Host "Pass: $env:RDP_PASSWORD"

    - name: Keep Alive
      run: |
        while ($true) {
            Write-Host "RDP Running... $(Get-Date)"
            Start-Sleep -Seconds 60
        }
